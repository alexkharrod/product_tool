{% extends "base.html" %}
{% block content %}
    <h2>Create New Quote</h2>
    <form method="POST" id="quoteForm">
        {{ form.hidden_tag() }}
        
        <div class="form-group mb-4">
            {{ form.customer_name.label }}
            {{ form.customer_name(class="form-control", autofocus=true) }}
            {% for error in form.customer_name.errors %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endfor %}
        </div>

        <h4 class="mt-4 mb-3">Pricing Tiers</h4>
        <table class="table table-bordered mt-3">
            <thead class="table-light">
                <tr>
                    <th>Tier</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Air Freight</th>
                    <th>Ocean Freight</th>
                    <th>Markup %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tiersContainer">
                {% for tier in form.tiers %}
                <tr class="tier-row">
                    <td class="align-middle">{{ loop.index }}</td>
                    <td>
                        {{ tier.quantity(class="form-control text-end", max="99999999", placeholder="Qty") }}
                        {% for error in tier.quantity.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    </td>
                    <td>
                        {{ tier.quote_price(class="form-control text-end", step="0.01", placeholder="0.00") }}
                        {% for error in tier.quote_price.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    </td>
                    <td>{{ tier.air_freight(class="form-control text-end", step="0.01", placeholder="0.00") }}</td>
                    <td>{{ tier.ocean_freight(class="form-control text-end", step="0.01", placeholder="0.00") }}</td>
                    <td>{{ tier.markup(class="form-control text-end", step="0.01", placeholder="0.00") }}</td>
                    <td class="align-middle">
                        {% if loop.index > 1 %}
                        <button type="button" class="btn btn-danger btn-sm remove-tier">Remove</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="mb-3">
            <button type="button" id="addTier" class="btn btn-secondary"
                {% if form.tiers|length >=5 %}disabled{% endif %}>
                Add More Tiers (Max 5)
            </button>
        </div>

        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('tiersContainer');
        const addButton = document.getElementById('addTier');
        let tierCount = {{ form.tiers|length }};

        addButton.addEventListener('click', function() {
            if (tierCount >= 5) return;
            
            const template = document.createElement('template');
            template.innerHTML = `
                <tr class="tier-row">
                    <td class="align-middle">${tierCount + 1}</td>
                    <td>
                        <input class="form-control text-end" 
                            name="tiers-${tierCount}-quantity" 
                            id="tiers-${tierCount}-quantity"
                            type="number" 
                            min="1" 
                            max="99999999" 
                            required
                            placeholder="Qty">
                        <div class="invalid-feedback">Required minimum quantity</div>
                    </td>
                    <td>
                        <input class="form-control text-end" 
                            name="tiers-${tierCount}-quote_price" 
                            id="tiers-${tierCount}-quote_price"
                            type="number" 
                            step="0.01" 
                            min="0.01" 
                            max="99999999.99"
                            required
                            placeholder="0.00">
                        <div class="invalid-feedback">Valid price required</div>
                    </td>
                    <td>
                        <input class="form-control text-end" 
                            name="tiers-${tierCount}-air_freight" 
                            id="tiers-${tierCount}-air_freight"
                            type="number" 
                            step="0.01" 
                            max="99999.99"
                            placeholder="0.00">
                    </td>
                    <td>
                        <input class="form-control text-end" 
                            name="tiers-${tierCount}-ocean_freight" 
                            id="tiers-${tierCount}-ocean_freight"
                            type="number" 
                            step="0.01" 
                            max="99999.99"
                            placeholder="0.00">
                    </td>
                    <td>
                        <input class="form-control text-end" 
                            name="tiers-${tierCount}-markup" 
                            id="tiers-${tierCount}-markup"
                            type="number" 
                            step="0.01" 
                            min="0" 
                            max="99.99"
                            placeholder="40">
                        <div class="invalid-feedback">Max 99.99%</div>
                    </td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-danger btn-sm remove-tier">Remove</button>
                    </td>
                </tr>
            `.trim();
            
            container.appendChild(template.content.firstChild);
            tierCount++;
            if (tierCount >= 5) addButton.disabled = true;
        });

        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-tier')) {
                e.target.closest('tr').remove();
                tierCount--;
                addButton.disabled = tierCount >= 5;
                // Update tier numbers
                Array.from(container.querySelectorAll('.tier-row')).forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
            }
        });
    });
    </script>
{% endblock %}
